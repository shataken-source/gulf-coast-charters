"use strict";(()=>{var e={};e.id=119,e.ids=[119],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6326:e=>{e.exports=import("resend")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},373:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>l,default:()=>u,routeModule:()=>c});var n=a(1802),i=a(7153),s=a(6249),o=a(6184),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,s.l)(o,"default"),l=(0,s.l)(o,"config"),c=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/admin/campaigns/[id]/send",pathname:"/api/admin/campaigns/[id]/send",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},6184:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>o});var n=a(2885),i=a(6326),s=e([i]);i=(s.then?(await s)():s)[0];let d=(0,n.createClient)("https://rdbuwyefbgnbuhmjrizo.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),u=new i.Resend(process.env.RESEND_API_KEY);async function o(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{id:a}=e.query;try{let{data:e,error:r}=await d.from("email_campaigns").select("*").eq("id",a).single();if(r||!e)return t.status(404).json({error:"Campaign not found"});let{data:n,error:i}=await d.from("email_campaign_recipients").select("*").eq("campaign_id",a).eq("status","pending");if(i)throw i;if(!n||0===n.length)return t.status(400).json({error:"No pending recipients"});let s=0,o=0;for(let t of n)try{let a=e.body.replace(/\{name\}/g,t.name||t.email.split("@")[0]).replace(/\{email\}/g,t.email),{data:r,error:n}=await u.emails.send({from:process.env.RESEND_FROM_EMAIL||"Gulf Coast Charters <onboarding@resend.dev>",to:[t.email],subject:e.subject,text:a,replyTo:process.env.RESEND_REPLY_TO||"shataken@gmail.com"});n?(await d.from("email_campaign_recipients").update({status:"failed",error_message:n.message}).eq("id",t.id),o++):(await d.from("email_campaign_recipients").update({status:"sent",sent_at:new Date().toISOString()}).eq("id",t.id),s++)}catch(e){console.error(`Failed to send to ${t.email}:`,e),await d.from("email_campaign_recipients").update({status:"failed",error_message:e.message}).eq("id",t.id),o++}let l=0===o?"sent":0===s?"failed":"sent";return await d.from("email_campaigns").update({status:l,sent_at:new Date().toISOString()}).eq("id",a),t.status(200).json({success:!0,successCount:s,failCount:o,totalRecipients:n.length})}catch(e){return console.error("Error sending campaign:",e),t.status(500).json({error:e.message})}}r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=373);module.exports=a})();